// EC2 Production Deployment with SCL
// Complete AWS EC2 server setup and application deployment
// Uses your Swan.pem key for SSH authentication

// Configuration for your EC2 instance
mode := "interpret";
setting := "configuration";
super_user := true;
on_error := "rollback";
target := "ec2-user@172.31.7.120";  // Your EC2 private IP

// Deployment configuration
declare environment: string = "production";
declare app_name: string = "my_web_app";
declare domain: string = "your-domain.com";
declare ssl_enabled: bool = true;
declare monitoring_enabled: bool = true;
declare backup_enabled: bool = true;

fn main() {
    print("ğŸš€ AWS EC2 Production Deployment");
    print("================================");
    print("Target: " + target);
    print("Environment: " + environment);
    print("Application: " + app_name);
    print("");
    
    // Phase 1: System Analysis
    ec2_system_check();
    
    // Phase 2: Security Hardening
    security_setup();
    
    // Phase 3: Install Dependencies
    install_dependencies();
    
    // Phase 4: Application Deployment
    deploy_application();
    
    // Phase 5: Web Server Configuration
    configure_web_server();
    
    // Phase 6: SSL Setup
    if (ssl_enabled) {
        setup_ssl();
    }
    
    // Phase 7: Monitoring Setup
    if (monitoring_enabled) {
        setup_monitoring();
    }
    
    // Phase 8: Backup Configuration
    if (backup_enabled) {
        setup_backup();
    }
    
    // Phase 9: Final Verification
    verify_deployment();
    
    print("âœ… EC2 deployment completed successfully!");
    print_deployment_info();
}

fn ec2_system_check() {
    print("ğŸ“Š Phase 1: EC2 System Analysis");
    print("--------------------------------");
    
    // Get comprehensive EC2 system information
    print("ğŸ” Analyzing EC2 instance...");
    sysinfo();
    
    // Monitor system performance
    print("ğŸ“ˆ Checking system performance...");
    monitor();
    
    // Security audit
    print("ğŸ”’ Initial security assessment...");
    audit();
    
    print("âœ… EC2 system analysis completed");
    print("");
}

fn security_setup() {
    print("ğŸ” Phase 2: Security Hardening");
    print("-------------------------------");
    
    // Update system packages first
    print("ğŸ“¦ Updating system packages...");
    package("update", "");
    
    // Install security tools
    print("ğŸ›¡ï¸ Installing security tools...");
    package("install", "fail2ban");
    package("install", "ufw");
    
    // Configure firewall
    print("ğŸ”¥ Configuring firewall...");
    firewall("enable");
    firewall("allow", "22/tcp");    // SSH
    firewall("allow", "80/tcp");    // HTTP
    firewall("allow", "443/tcp");   // HTTPS
    
    // Start security services
    service("enable", "fail2ban");
    service("start", "fail2ban");
    
    // Create application user
    print("ğŸ‘¤ Creating application user...");
    user("add", "appuser");
    user("sudo", "appuser");
    
    print("âœ… Security hardening completed");
    print("");
}

fn install_dependencies() {
    print("ğŸ“¦ Phase 3: Installing Dependencies");
    print("------------------------------------");
    
    // Web server
    print("ğŸŒ Installing Nginx...");
    package("install", "nginx");
    
    // Node.js (for modern web apps)
    print("ğŸ“— Installing Node.js...");
    package("install", "nodejs");
    package("install", "npm");
    
    // Database
    print("ğŸ—„ï¸ Installing database...");
    package("install", "postgresql");
    
    // Development tools
    print("ğŸ› ï¸ Installing development tools...");
    package("install", "git");
    package("install", "curl");
    package("install", "htop");
    
    // Docker (for containerized apps)
    print("ğŸ³ Installing Docker...");
    package("install", "docker");
    
    print("âœ… Dependencies installed");
    print("");
}

fn deploy_application() {
    print("ğŸš€ Phase 4: Application Deployment");
    print("-----------------------------------");
    
    // Create application directories
    print("ğŸ“ Creating application structure...");
    create("/var/www/" + app_name, "index.html", "644");
    create("/var/www/" + app_name + "/static", "style.css", "644");
    create("/var/www/" + app_name + "/api", "server.js", "644");
    create("/var/log/" + app_name, "app.log", "644");
    create("/etc/" + app_name, "config.json", "600");
    
    // Copy application files (you'd replace these with real files)
    print("ğŸ“‹ Deploying application files...");
    // Note: In real deployment, you'd copy actual files:
    // copy("dist/index.html", "/var/www/" + app_name + "/index.html");
    // copy("config/production.json", "/etc/" + app_name + "/config.json");
    
    // Set proper permissions
    print("ğŸ” Setting file permissions...");
    create("/var/www/" + app_name + "/uploads", "README.txt", "755");
    
    print("âœ… Application deployed");
    print("");
}

fn configure_web_server() {
    print("ğŸŒ Phase 5: Web Server Configuration");
    print("------------------------------------");
    
    // Create Nginx configuration
    print("âš™ï¸ Configuring Nginx...");
    create("/etc/nginx/sites-available", app_name + ".conf", "644");
    
    // Enable the site (simulate linking)
    create("/etc/nginx/sites-enabled", app_name + ".conf", "644");
    
    // Test Nginx configuration
    print("ğŸ§ª Testing Nginx configuration...");
    webserver("nginx", "test");
    
    // Start and enable Nginx
    print("ğŸš€ Starting Nginx...");
    service("enable", "nginx");
    service("start", "nginx");
    
    print("âœ… Web server configured");
    print("");
}

fn setup_ssl() {
    print("ğŸ” Phase 6: SSL Configuration");
    print("------------------------------");
    
    // Install Certbot for Let's Encrypt
    print("ğŸ“œ Installing SSL certificate tools...");
    package("install", "certbot");
    package("install", "python3-certbot-nginx");
    
    if (environment == "production") {
        print("ğŸŒ Setting up Let's Encrypt SSL...");
        cert("letsencrypt", domain);
    } else {
        print("ğŸ”’ Creating self-signed certificate...");
        cert("generate_self_signed", domain);
    }
    
    // Update Nginx for SSL
    print("ğŸ”„ Updating Nginx for SSL...");
    webserver("nginx", "reload");
    
    print("âœ… SSL configured");
    print("");
}

fn setup_monitoring() {
    print("ğŸ“Š Phase 7: Monitoring Setup");
    print("-----------------------------");
    
    // Install monitoring tools
    print("ğŸ“ˆ Installing monitoring tools...");
    package("install", "htop");
    package("install", "iotop");
    
    // Setup log monitoring
    print("ğŸ“‹ Configuring log monitoring...");
    logs("/var/log/nginx/access.log", "", 10);
    logs("/var/log/nginx/error.log", "error", 5);
    logs("/var/log/" + app_name + "/app.log", "", 10);
    
    // System performance monitoring
    print("âš¡ Setting up performance monitoring...");
    monitor();
    
    // Setup monitoring cron jobs
    print("â° Setting up automated monitoring...");
    cron("add", "*/5 * * * *", "/usr/local/bin/health-check.sh", "root");
    cron("add", "0 */6 * * *", "/usr/local/bin/system-report.sh", "root");
    
    print("âœ… Monitoring configured");
    print("");
}

fn setup_backup() {
    print("ğŸ’¾ Phase 8: Backup Configuration");
    print("---------------------------------");
    
    // Create backup directories
    print("ğŸ“ Creating backup structure...");
    create("/backup", "README.txt", "755");
    create("/backup/daily", "info.txt", "755");
    create("/backup/weekly", "info.txt", "755");
    
    // Setup backup scripts
    print("ğŸ“œ Setting up backup automation...");
    cron("add", "0 2 * * *", "/usr/local/bin/daily-backup.sh", "root");
    cron("add", "0 3 * * 0", "/usr/local/bin/weekly-backup.sh", "root");
    
    // Initial backup
    print("ğŸ’¾ Creating initial backup...");
    backup("backup", "/var/www/" + app_name, "/backup/initial-deployment.tar.gz");
    backup("backup", "/etc/" + app_name, "/backup/initial-config.tar.gz");
    
    print("âœ… Backup system configured");
    print("");
}

fn verify_deployment() {
    print("âœ… Phase 9: Deployment Verification");
    print("------------------------------------");
    
    // Check all services
    print("ğŸ” Verifying services...");
    service("status", "nginx");
    service("status", "postgresql");
    service("status", "fail2ban");
    
    // Network connectivity tests
    print("ğŸŒ Testing network connectivity...");
    nettest("localhost:80", "telnet");
    
    if (ssl_enabled) {
        nettest("localhost:443", "telnet");
    }
    
    // Security verification
    print("ğŸ”’ Security verification...");
    firewall("status");
    audit();
    
    // Performance check
    print("ğŸ“Š Final performance check...");
    monitor();
    
    print("âœ… Deployment verification completed");
    print("");
}

fn print_deployment_info() {
    print("ğŸ¯ Deployment Information");
    print("=========================");
    print("");
    print("ğŸŒ Your application is deployed at:");
    print("   HTTP:  http://" + domain);
    
    if (ssl_enabled) {
        print("   HTTPS: https://" + domain);
    }
    
    print("");
    print("ğŸ“ Application files:");
    print("   â€¢ Web root: /var/www/" + app_name + "/");
    print("   â€¢ Config: /etc/" + app_name + "/");
    print("   â€¢ Logs: /var/log/" + app_name + "/");
    print("   â€¢ Backups: /backup/");
    print("");
    
    print("ğŸ”§ Management commands:");
    print("   â€¢ Check status: systemctl status nginx");
    print("   â€¢ View logs: tail -f /var/log/nginx/access.log");
    print("   â€¢ Restart app: systemctl restart nginx");
    print("");
    
    print("ğŸ”’ Security features:");
    print("   âœ“ Firewall configured (UFW)");
    print("   âœ“ Fail2ban protection active");
    
    if (ssl_enabled) {
        print("   âœ“ SSL/TLS encryption enabled");
    }
    
    print("   âœ“ Application user created");
    print("");
    
    if (monitoring_enabled) {
        print("ğŸ“Š Monitoring:");
        print("   âœ“ System monitoring active");
        print("   âœ“ Log monitoring configured");
        print("   âœ“ Automated health checks");
        print("");
    }
    
    if (backup_enabled) {
        print("ğŸ’¾ Backup:");
        print("   âœ“ Daily backups scheduled");
        print("   âœ“ Weekly backups scheduled");
        print("   âœ“ Initial backup created");
        print("");
    }
    
    print("ğŸš€ Your EC2 instance is production-ready!");
}